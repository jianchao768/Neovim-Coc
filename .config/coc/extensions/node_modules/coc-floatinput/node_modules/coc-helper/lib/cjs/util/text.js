"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
exports.displayHeight = exports.displayWidth = exports.byteLength = exports.byteIndex = exports.generateUri = void 0;
const coc_nvim_1 = require("coc.nvim");
const collection_1 = require("./collection");
const env_1 = require("./env");
function generateUri(path, scheme = 'file') {
    if (scheme === 'file' && env_1.isWindows && /^[A-Za-z]:/.test(path)) {
        path = `/${path}`;
    }
    return `${scheme}://${path}`;
}
exports.generateUri = generateUri;
function byteIndex(content, index) {
    const s = content.slice(0, index);
    return Buffer.byteLength(s);
}
exports.byteIndex = byteIndex;
function byteLength(str) {
    return Buffer.byteLength(str);
}
exports.byteLength = byteLength;
async function displayWidth(content) {
    return (await coc_nvim_1.workspace.nvim.call('strdisplaywidth', [content]));
}
exports.displayWidth = displayWidth;
async function displayHeight(width, lines, 
/**
 * line is 1-index, column is 0-index
 */
cursor, mode = 'n') {
    const heightGroup = await Promise.all(lines.map(async (l, idx) => {
        let strwidth = await displayWidth(l);
        if (mode === 'i' &&
            cursor &&
            cursor[0] - 1 === idx &&
            cursor[1] + 1 >= strwidth) {
            strwidth += 1;
        }
        return Math.ceil(strwidth / width);
    }));
    return (0, collection_1.sum)(heightGroup);
}
exports.displayHeight = displayHeight;
